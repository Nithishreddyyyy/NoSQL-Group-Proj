<!DOCTYPE html>
<html>
<head>
    <title>Faculty Appraisal Scores</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

    
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar">
  <div class="nav-container">
    
    <!-- Clickable title linking to home "/" -->
    <a href="/" class="nav-title">Faculty Appraisal System</a>

    <ul class="nav-links">
      <li><a href="/faculty">Faculty Management</a></li>
      <li><a href="/criteria">Criteria Management</a></li>
      <li><a href="/scores">Score Calculation</a></li>
    </ul>
  </div>
</nav>

    <h1>Faculty Appraisal Scores</h1>
    <div class="box">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Department</th>
                    <th>Selected Criteria</th>
                    <th>Total Score</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for faculty in scores %}
                <tr>
                    <td>{{ faculty.name }}</td>
                    <td>{{ faculty.department }}</td>
                    <td>
                        <form method="post" action="/scores/update/{{ faculty.id }}" id="form-{{ faculty.id }}">
                            <div class="criteria-container" id="criteria-list-{{ faculty.id }}">
                                {% set criteria_counts = {} %}
                                {% for criterion_name in faculty.selected_criteria %}
                                    {% if criterion_name in criteria_counts %}
                                        {% set _ = criteria_counts.update({criterion_name: criteria_counts[criterion_name] + 1}) %}
                                    {% else %}
                                        {% set _ = criteria_counts.update({criterion_name: 1}) %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% for criterion_name, count in criteria_counts.items() %}
                                <div class="criteria-item" data-criterion="{{ criterion_name }}">
                                    {% for i in range(count) %}
                                    <input type="hidden" name="criteria" value="{{ criterion_name }}">
                                    {% endfor %}
                                    <span>{{ criterion_name }}</span>
                                    <span class="criteria-count" data-count="{{ count }}">{{ count }}</span>
                                    <button type="button" onclick="removeCriteria(event, '{{ faculty.id }}', '{{ criterion_name }}')">×</button>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="add-criteria-section">
                                <select id="criteria-select-{{ faculty.id }}">
                                    <option value="">Add...</option>
                                    {% for criterion in all_criteria %}
                                    <option value="{{ criterion.name }}">{{ criterion.name }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" onclick="addCriteria(event, '{{ faculty.id }}')">+</button>
                                <button type="submit">Save</button>
                            </div>
                        </form>
                    </td>
                    <td>{{ "%.2f" | format(faculty.total_score) }}</td>
                    <td>
                        <a href="/scores/pdf/{{ faculty.id }}" class="btn-secondary">Generate PDF</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        function addCriteria(event, facultyId) {
            event.preventDefault();
            const select = document.getElementById(`criteria-select-${facultyId}`);
            const criteriaList = document.getElementById(`criteria-list-${facultyId}`);
            const value = select.value;

            if (!value) {
                alert('Please select a criterion');
                return;
            }

            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'criteria';
            input.value = value;
            
            const existingItem = criteriaList.querySelector(`[data-criterion="${value}"]`);
            if (existingItem) {
                existingItem.appendChild(input);
                const countSpan = existingItem.querySelector('[data-count]');
                const newCount = parseInt(countSpan.getAttribute('data-count')) + 1;
                countSpan.setAttribute('data-count', newCount);
                countSpan.textContent = newCount;
            } else {
                const div = document.createElement('div');
                div.className = 'criteria-item';
                div.setAttribute('data-criterion', value);
                div.innerHTML = `
                    <span>${value}</span>
                    <span class="criteria-count" data-count="1">1</span>
                    <button type="button" onclick="removeCriteria(event, '${facultyId}', '${value}')">×</button>
                `;
                div.appendChild(input);
                criteriaList.appendChild(div);
            }

            select.value = '';
        }

        function removeCriteria(event, facultyId, criterionName) {
            event.preventDefault();
            const criteriaList = document.getElementById(`criteria-list-${facultyId}`);
            const criteriaItem = criteriaList.querySelector(`[data-criterion="${criterionName}"]`);
            
            if (criteriaItem) {
                const hiddenInputs = criteriaItem.querySelectorAll(`input[value="${criterionName}"]`);
                
                if (hiddenInputs.length > 1) {
                    hiddenInputs[0].remove();
                    const countSpan = criteriaItem.querySelector('[data-count]');
                    const newCount = parseInt(countSpan.getAttribute('data-count')) - 1;
                    countSpan.setAttribute('data-count', newCount);
                    countSpan.textContent = newCount;
                } else if (hiddenInputs.length === 1) {
                    criteriaItem.remove();
                }
            }
        }
    </script>

    <div style="text-align: center; margin: 20px;">
        <a href="/scores/pdf/all" class="btn-secondary" style="padding: 10px 20px; font-size: 16px;">Download All Faculty Reports</a>
    </div>

</body>
</html>